<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    x:Class="Gym.Pages.PostListPage"
    x:Name="PostListPageRef"
    Title="Posts"
    BackgroundColor="#F5F5F5">

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="12" Spacing="12">

                <!-- Button tạo bài viết -->
                <Button x:Name="CreatePostButton"
                        Text="➕ Create Post"
                        Clicked="OnCreatePostClicked"
                        HorizontalOptions="End"
                        BackgroundColor="#FF5722"
                        TextColor="White"
                        CornerRadius="20"
                        Padding="10,5"/>

                <!-- Danh sách bài viết -->
                <CollectionView x:Name="PostListView" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>

                            <Frame CornerRadius="12"
                                   Padding="12"
                                   Margin="0,6"
                                   HasShadow="True"
                                   BackgroundColor="White"
                                   BorderColor="#E0E0E0">

                                <VerticalStackLayout Spacing="6">

                                    <!-- Header: Title -->
                                    <Label Text="{Binding Title}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>

                                    <!-- Subheader: UserName + Ngày đăng -->
                                    <HorizontalStackLayout Spacing="10">
                                        <Label Text="{Binding UserName}"
                                               FontSize="12"
                                               TextColor="#666"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding CreatedAt, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}"
                                               FontSize="12"
                                               TextColor="#999"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>

                                    <!-- Nội dung bài viết -->
                                    <Label Text="{Binding Content}"
                                           FontSize="14"
                                           LineBreakMode="WordWrap"/>

                                    <!-- MEDIA CAROUSEL -->
                                    <Grid IsVisible="{Binding HasMedia}"
                                          HeightRequest="250"
                                          Margin="0,6">

                                        <CarouselView x:Name="PostMediaCarousel"
                                                      ItemsSource="{Binding AllMedia}"
                                                      IndicatorView="mediaIndicator"
                                                      HeightRequest="250">

                                            <CarouselView.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid>

                                                        <!-- IMAGE -->
                                                        <Image Source="{Binding Url}"
                                                               Aspect="AspectFill"
                                                               IsVisible="{Binding IsImage}">
                                                            <Image.GestureRecognizers>
                                                                <TapGestureRecognizer 
                                                                    Command="{Binding Source={x:Reference PostListPageRef}, Path=BindingContext.ImageClickedCommand}"
                                                                    CommandParameter="{Binding Url}" />
                                                            </Image.GestureRecognizers>
                                                        </Image>

                                                        <!-- VIDEO -->
                                                        <toolkit:MediaElement Source="{Binding Url}"
                                                                              ShouldAutoPlay="False"
                                                                              IsVisible="{Binding IsVideo}"
                                                                              Aspect="AspectFill"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </CarouselView.ItemTemplate>

                                        </CarouselView>

                                        <!-- PREV BUTTON -->
                                        <Button Text="←"
                                                BackgroundColor="#66000000"
                                                TextColor="White"
                                                WidthRequest="40"
                                                HeightRequest="80"
                                                CornerRadius="8"
                                                Clicked="OnPrevMediaClicked"
                                                HorizontalOptions="Start"
                                                VerticalOptions="Center"
                                                IsVisible="{Binding HasMultipleMedia}"/>

                                        <!-- NEXT BUTTON -->
                                        <Button Text="→"
                                                BackgroundColor="#66000000"
                                                TextColor="White"
                                                WidthRequest="40"
                                                HeightRequest="80"
                                                CornerRadius="8"
                                                Clicked="OnNextMediaClicked"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center"
                                                IsVisible="{Binding HasMultipleMedia}"/>

                                    </Grid>

                                    <!-- Indicator -->
                                    <IndicatorView x:Name="mediaIndicator"
                                                   IsVisible="{Binding HasMedia}"
                                                   Margin="0,4"
                                                   HorizontalOptions="Center"/>

                                    <!-- Edit/Delete -->
                                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End" Margin="0,4">
                                        <Button Text="Edit"
                                                Clicked="OnEditClicked"
                                                CommandParameter="{Binding}"
                                                IsVisible="{Binding IsOwned}"
                                                BackgroundColor="#03A9F4"
                                                TextColor="White"
                                                CornerRadius="15"
                                                Padding="10,5"/>
                                        <Button Text="Delete"
                                                Clicked="OnDeleteClicked"
                                                CommandParameter="{Binding}"
                                                TextColor="White"
                                                BackgroundColor="#F44336"
                                                IsVisible="{Binding IsOwned}"
                                                CornerRadius="15"
                                                Padding="10,5"/>
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>
                            </Frame>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- FULLSCREEN IMAGE MODAL -->
        <Grid x:Name="FullImageModal"
              BackgroundColor="#80000000"
              IsVisible="False"
              ZIndex="999"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">

            <Image x:Name="FullImageView"
                   Aspect="AspectFit"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   WidthRequest="350"/>

            <Button Text="✕"
                    FontSize="26"
                    BackgroundColor="#AA000000"
                    TextColor="White"
                    CornerRadius="30"
                    WidthRequest="50"
                    HeightRequest="50"
                    HorizontalOptions="End"
                    VerticalOptions="Start"
                    Margin="20"
                    Clicked="OnCloseFullImage"/>
        </Grid>

    </Grid>
</ContentPage>
